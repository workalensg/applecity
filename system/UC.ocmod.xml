<modification>
    <name>Укркредит</name>
	<version>1.1.0</version>
	<link>https://fringe.com.ua</link>
	<author>Stealth</author>
	<code>ukrcredit_ocmod</code>

	<file path="admin/controller/{extension,extension/extension}/payment.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$extension = basename($file, '.php');]]></search>
			<add position="after"><![CDATA[if ($extension == 'ukrcredits_pp' || $extension == 'ukrcredits_ii' || $extension == 'ukrcredits_mb' || $extension == 'ukrcredits_ab') continue;]]></add>
		</operation>
	</file>
	
	<file path="admin/controller/sale/order.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$content = $this->load->controller('payment/' . $order_info['payment_code'] . '/order');]]></search>
			<add position="replace"><![CDATA[
				if (file_exists(DIR_APPLICATION . 'controller/payment/' . $order_info['payment_code'] . '.php')) {
					$content = $this->load->controller('payment/' . $order_info['payment_code'] . '/order');
				} else {
					$content = null;
				}
			]]></add>
		</operation>
	</file>
	
	/* FOR 2.3 */
	<file path="admin/controller/extension/extension/payment.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$this->load->controller('extension/payment/' . $this->request->get['extension'] . '/install');]]></search>
			<add position="after"><![CDATA[
			if ($this->request->get['extension'] == 'ukrcredits') {
				$this->load->controller('payment/' . $this->request->get['extension'] . '/install');
				$this->model_user_user_group->addPermission($this->user->getGroupId(), 'access', 'payment/' . $this->request->get['extension']);
				$this->model_user_user_group->addPermission($this->user->getGroupId(), 'modify', 'payment/' . $this->request->get['extension']);
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA[$this->load->controller('extension/payment/' . $this->request->get['extension'] . '/uninstall');]]></search>
			<add position="after"><![CDATA[$this->load->controller('payment/' . $this->request->get['extension'] . '/uninstall');]]></add>
		</operation>
	</file>
	<file path="admin/controller/extension/extension/total.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$this->load->controller('extension/total/' . $this->request->get['extension'] . '/install');]]></search>
			<add position="after"><![CDATA[
			if ($this->request->get['extension'] == 'totalukrcredits') {
				$this->load->controller('total/' . $this->request->get['extension'] . '/install');
				$this->model_user_user_group->addPermission($this->user->getGroupId(), 'access', 'total/' . $this->request->get['extension']);
				$this->model_user_user_group->addPermission($this->user->getGroupId(), 'modify', 'total/' . $this->request->get['extension']);
			}
			]]></add>
		</operation>
	</file>
	<file path="system/config/catalog.php">
		<operation error="skip">
			<search><![CDATA['model/extension/analytics/*/before']]></search>
			<add position="before"><![CDATA[
	//		'controller/extension/payment/*/before'   => 'event/compatibility/controller',
			]]></add>
		</operation>
	</file>
	/* permission fix FOR 2.3-3.0 */
	<file path="admin/controller/startup/permission.php">
		<operation error="skip">
			<search><![CDATA[if (!in_array($route, $ignore)]]></search>
			<add position="before"><![CDATA[
			if ($route == 'extension/payment/ukrcredits') {
				$route = 'payment/ukrcredits';
			}
			if ($route == 'extension/total/totalukrcredits') {
				$route = 'total/totalukrcredits';
			}
			]]></add>
		</operation>
	</file>	
	
	/* FOR 3.0 */
	<file path="admin/controller/extension/extension/payment.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$files = glob(DIR_APPLICATION . 'controller/extension/payment/*.php');]]></search>
			<add position="replace"><![CDATA[$files = glob(DIR_APPLICATION . 'controller/{extension/payment,payment}/*.php', GLOB_BRACE);]]></add>
		</operation>
	</file>
	<file path="admin/controller/extension/extension/total.php" error="skip">
		<operation error="skip">
			<search><![CDATA[$files = glob(DIR_APPLICATION . 'controller/extension/total/*.php');]]></search>
			<add position="replace"><![CDATA[$files = glob(DIR_APPLICATION . 'controller/{extension/total,total}/*.php', GLOB_BRACE);]]></add>
		</operation>
	</file>
	<file path="system/config/admin.php">
		<operation error="skip">
			<search><![CDATA['controller/*/before' => array(]]></search>
			<add position="after"><![CDATA[
			'payment/ukrcredits/controller',
			]]></add>
		</operation>
	</file>
	<file path="system/config/catalog.php">
		<operation error="skip">
			<search><![CDATA['controller/*/before' => array(]]></search>
			<add position="before"><![CDATA[
			'model/*/before' => array(
				'module/ukrcredits/beforemodel'
			),
			'model/*/after' => array(
				'module/ukrcredits/aftermodel'
			),
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA['controller/*/before' => array(]]></search>
			<add position="after"><![CDATA[
			'module/ukrcredits/controller',
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA['controller/*/after' => array(]]></search>
			<add position="after"><![CDATA[
			'module/ukrcredits/controller',
			]]></add>
		</operation>
	</file>
	<file path="system/engine/loader.php">
		<operation error="skip">
			<search><![CDATA[if (!$this->registry->has('model_']]></search>
			<add position="before"><![CDATA[
		if ($route == 'extension/payment/ukrcredits_pp' || $route == 'extension/payment/ukrcredits_ii' || $route == 'extension/payment/ukrcredits_mb' || $route == 'extension/payment/ukrcredits_ab' || $route == 'extension/payment/ukrcredits') {
			$this->registry->get('event')->trigger('model/' . $route . '/before', array(&$route));
		}
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA[throw new \Exception('Error: Could not load model ']]></search>
			<add position="after" offset="1"><![CDATA[
			$this->registry->get('event')->trigger('model/'.$route.'/after', array(&$route));
			]]></add>
		</operation>
		<operation error="skip">
			<search><![CDATA[include_once($file);]]></search>
			<add position="replace"><![CDATA[
			include_once(modification($file));
			]]></add>
		</operation>		
	</file>
	
	<file path="system/library/session.php">
		<operation error="skip">
			<search><![CDATA[exit();]]></search>
			<add position="after" offset="1"><![CDATA[
	if (version_compare(VERSION,'3.0','>=')) {
		if ($this->adaptor && !session_id()) {
			session_start();
		}
	}
			]]></add>
		</operation>
	</file>
	
	<file path="admin/controller/catalog/category.php">
		<operation>
			<search><![CDATA[public function autocomplete()]]></search>
			<add position="before"><![CDATA[
	 public function productsAutocomplete(){
		 $json=array();
		 
		 if(isset($this->request->get['filter_name'])||isset($this->request->get['filter_model'])||isset($this->request->get['filter_category_id'])){
		 
			 $this->load->model('catalog/product');
			 
			 if(isset($this->request->get['filter_name'])){
				$filter_name=$this->request->get['filter_name'];
			 } else {
				$filter_name='';
			 }
			 
			 if(isset($this->request->get['filter_model'])){
				$filter_model=$this->request->get['filter_model'];
			 } else {
				$filter_model='';
			 }
			 if(isset($this->request->get['filter_category_id'])){
				$filter_category=$this->request->get['filter_category_id'];
			 } else {
				$filter_category='';
			 }
			 if(isset($this->request->get['limit'])){
				$limit=$this->request->get['limit'];
			 } else {
				$limit=5000;
			 }
			 
			 $filter_data=array(
				 'filter_category'=>$filter_category,
				 'filter_name'=>$filter_name,
				 'filter_model'=>$filter_model,
				 'start'=>0,
				 'limit'=>$limit
			 );
			 
			 $results = $this->model_catalog_product->getProducts($filter_data);
			 
			 foreach($results as $result){
				 $json[]=array(
					 'product_id'=>$result['product_id'],
					 'name'=>strip_tags(html_entity_decode($result['name'],ENT_QUOTES,'UTF-8')),
					 'model'=>$result['model'],
					 'price'=>$result['price']
				 );
			 }
		 }
		 $this->response->setOutput(json_encode($json));
	 }
			]]></add>
		</operation>
	</file>	
	<file path="admin/language/*/catalog/product.php">
		<operation>
			<search ><![CDATA[$_['error_warning']]]></search>
			<add position="before"><![CDATA[
$_['tab_ukrcredits']			= 'Кредиты';
$_['credit_type']				= 'Вид кредитования:';
$_['partsCount']				= 'Максимум месяцев:';
$_['markup']					= 'Коэффициент наценки:';
$_['help_partsCount']			= 'Введите максимальное количество месяцев кредитования';
$_['help_markup']				= 'Если необходимо, установите наценку на стоимость товара, например 1.027, что составляет 2.7%';
$_['credit_type_ii']			= 'Мгновенная рассрочка (Приватбанк)';
$_['credit_type_pp']			= 'Оплата частями (Приватбанк)';
$_['credit_type_mb']			= 'Покупка частями (Монобанк)';
$_['credit_type_ab']			= 'Легкая рассрочка (Альфа-банк)';
			]]></add>
		</operation>
	</file>
	<file path="admin/controller/catalog/product.php">
		<operation>
			<search ><![CDATA[if (isset($this->request->get['product_id']) &&]]></search>
			<add position="before"><![CDATA[
		$type = version_compare(VERSION,'3.0','>=') ? 'payment_' : '';
		if ($this->config->get($type.'ukrcredits_status')) {
			
			$data['ukrcredits_status'] = true;
			$data['tab_ukrcredits'] = $this->language->get('tab_ukrcredits');
			$data['credit_type'] = $this->language->get('credit_type');
			$data['credit_type_ii'] = $this->language->get('credit_type_ii');
			$data['credit_type_pp'] = $this->language->get('credit_type_pp');
			$data['credit_type_mb'] = $this->language->get('credit_type_mb');
			$data['credit_type_ab'] = $this->language->get('credit_type_ab');
			$data['partsCount'] = $this->language->get('partsCount');
			$data['markup'] = $this->language->get('markup');
			$data['help_partsCount'] = $this->language->get('help_partsCount');
			$data['help_markup'] = $this->language->get('help_markup');			
		
            if (isset($this->request->get['product_id']) && ($this->request->server['REQUEST_METHOD'] != 'POST')) {
                $credit_info = $this->model_catalog_product->getProductUkrcredits($this->request->get['product_id']);
            }

			$data['partscounts'] = array();
			for($i=24;$i>=1;$i--){
				$data['partscounts'][] = $i;           
			}
			
			if (isset($this->request->post['product_pp'])) {
				$data['product_pp'] = $this->request->post['product_pp'];
			} elseif (!empty($credit_info)) {
				$data['product_pp'] = $credit_info['product_pp'];
			} else {
				$data['product_pp'] = '';
			}

			if (isset($this->request->post['product_ii'])) {
				$data['product_ii'] = $this->request->post['product_ii'];
			} elseif (!empty($credit_info)) {
				$data['product_ii'] = $credit_info['product_ii'];
			} else {
				$data['product_ii'] = '';
			}
			
			if (isset($this->request->post['product_mb'])) {
				$data['product_mb'] = $this->request->post['product_mb'];
			} elseif (!empty($credit_info)) {
				$data['product_mb'] = $credit_info['product_mb'];
			} else {
				$data['product_mb'] = '';
			}

			if (isset($this->request->post['product_ab'])) {
				$data['product_ab'] = $this->request->post['product_ab'];
			} elseif (!empty($credit_info)) {
				$data['product_ab'] = $credit_info['product_ab'];
			} else {
				$data['product_ab'] = '';
			}
			
			if (isset($this->request->post['partscount_pp'])) {
				$data['partscount_pp'] = $this->request->post['partscount_pp'];
			} elseif (!empty($credit_info)) {
				$data['partscount_pp'] = $credit_info['partscount_pp'];
			} else {
				$data['partscount_pp'] = '';
			}
			
			if (isset($this->request->post['partscount_ii'])) {
				$data['partscount_ii'] = $this->request->post['partscount_ii'];
			} elseif (!empty($credit_info)) {
				$data['partscount_ii'] = $credit_info['partscount_ii'];
			} else {
				$data['partscount_ii'] = '';
			}
			
			if (isset($this->request->post['partscount_mb'])) {
				$data['partscount_mb'] = $this->request->post['partscount_mb'];
			} elseif (!empty($credit_info)) {
				$data['partscount_mb'] = $credit_info['partscount_mb'];
			} else {
				$data['partscount_mb'] = '';
			}

			if (isset($this->request->post['partscount_ab'])) {
				$data['partscount_ab'] = $this->request->post['partscount_ab'];
			} elseif (!empty($credit_info)) {
				$data['partscount_ab'] = $credit_info['partscount_ab'];
			} else {
				$data['partscount_ab'] = '';
			}
			
			if (isset($this->request->post['markup_pp'])) {
				$data['markup_pp'] = $this->request->post['markup_pp'];
			} elseif (!empty($credit_info)) {
				$data['markup_pp'] = $credit_info['markup_pp'];
			} else {
				$data['markup_pp'] = '';
			}
			
			if (isset($this->request->post['markup_ii'])) {
				$data['markup_ii'] = $this->request->post['markup_ii'];
			} elseif (!empty($credit_info)) {
				$data['markup_ii'] = $credit_info['markup_ii'];
			} else {
				$data['markup_ii'] = '';
			}

			if (isset($this->request->post['markup_mb'])) {
				$data['markup_mb'] = $this->request->post['markup_mb'];
			} elseif (!empty($credit_info)) {
				$data['markup_mb'] = $credit_info['markup_mb'];
			} else {
				$data['markup_mb'] = '';
			}
			
			if (isset($this->request->post['markup_ab'])) {
				$data['markup_ab'] = $this->request->post['markup_ab'];
			} elseif (!empty($credit_info)) {
				$data['markup_ab'] = $credit_info['markup_ab'];
			} else {
				$data['markup_ab'] = '';
			}	
			
		} else {
			$data['ukrcredits_status'] = false;
		}
			]]></add>
		</operation>
	</file>	
	<file path="admin/model/catalog/product.php">
		<operation error="log">
			<search ><![CDATA[public function editProduct($product_id, $data) {]]></search>
			<add position="after"><![CDATA[
if (isset($data['partscount_pp'])) {
	if ($data['partscount_pp'] || $data['partscount_ii'] || $data['partscount_mb'] || $data['product_pp'] || $data['product_ii'] || $data['product_mb'] || $data['markup_pp'] || $data['markup_ii'] || $data['markup_mb']) {
			$this->db->query("DELETE FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_id . "'");
			$this->db->query("INSERT INTO " . DB_PREFIX . "product_ukrcredits SET product_id = '" . (int)$product_id . "', product_ii = '" . $this->db->escape($data['product_ii']) . "', product_pp = '" . $this->db->escape($data['product_pp']) . "', product_mb = '" . $this->db->escape($data['product_mb']) . "', product_ab = '" . $this->db->escape($data['product_ab']) . "', partscount_pp = '" . $this->db->escape($data['partscount_pp']) . "', partscount_ii = '" . $this->db->escape($data['partscount_ii']) . "', partscount_mb = '" . $this->db->escape($data['partscount_mb']) . "', partscount_ab = '" . $this->db->escape($data['partscount_ab']) . "', markup_pp = '" . $this->db->escape($data['markup_pp']) . "', markup_ii = '" . $this->db->escape($data['markup_ii']) . "', markup_mb = '" . $this->db->escape($data['markup_mb']) . "', markup_ab = '" . $this->db->escape($data['markup_ab']) . "'");
	}
}
			]]></add>
		</operation>
		<operation error="log">
			<search ><![CDATA[$product_id = $this->db->getLastId();]]></search>
			<add position="after"><![CDATA[
if (isset($data['partscount_pp'])) {
	if ($data['partscount_pp'] || $data['partscount_ii'] || $data['partscount_mb'] || $data['partscount_ab'] || $data['product_pp'] || $data['product_ii'] || $data['product_mb'] || $data['product_ab'] || $data['markup_pp'] || $data['markup_ii'] || $data['markup_mb'] || $data['markup_ab']) {
			$this->db->query("INSERT INTO " . DB_PREFIX . "product_ukrcredits SET product_id = '" . (int)$product_id . "', product_ii = '" . $this->db->escape($data['product_ii']) . "', product_pp = '" . $this->db->escape($data['product_pp']) . "', product_mb = '" . $this->db->escape($data['product_mb']) . "', product_ab = '" . $this->db->escape($data['product_ab']) . "', partscount_pp = '" . $this->db->escape($data['partscount_pp']) . "', partscount_ii = '" . $this->db->escape($data['partscount_ii']) . "', partscount_mb = '" . $this->db->escape($data['partscount_mb']) . "', partscount_ab = '" . $this->db->escape($data['partscount_ab']) . "', markup_pp = '" . $this->db->escape($data['markup_pp']) . "', markup_ii = '" . $this->db->escape($data['markup_ii']) . "', markup_mb = '" . $this->db->escape($data['markup_mb']) . "', markup_ab = '" . $this->db->escape($data['markup_ab']) . "'");
	}
}
			]]></add>
		</operation>
		<operation error="log">
			<search ><![CDATA[deleteProduct($product_id) {]]></search>
			<add position="after"><![CDATA[
		$this->db->query("DELETE FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_id . "'");
			]]></add>
		</operation>
		<operation error="log">
			<search index="0"><![CDATA[public function getProductAttributes]]></search>
			<add position="before"><![CDATA[
	public function getProductUkrcredits($product_id) {
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_id . "'");

		return $query->row;
	}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$data['status'] = '0';]]></search>
			<add position="after"><![CDATA[
		$data = array_merge($data, $this->getProductUkrcredits($product_id));
			]]></add>
		</operation>
	</file>	
	<file path="admin/view/template/catalog/product_form.tpl" error="skip">
		<operation error="skip">
			<search ><![CDATA[<li><a href="#tab-attribute" data-toggle="tab">]]></search>
			<add position="before"><![CDATA[
			<?php if ($ukrcredits_status) { ?>
			<li><a href="#tab-ukrcredits" data-toggle="tab"><?php echo $tab_ukrcredits; ?></a></li>
			<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search ><![CDATA[<div class="tab-pane" id="tab-attribute">]]></search>
			<add position="before"><![CDATA[
			<?php if ($ukrcredits_status) { ?>
			<div class="tab-pane" id="tab-ukrcredits">
              <div class="table-responsive">
                <table id="ukrcredits" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <td class="text-left"><?php echo $credit_type; ?></td>
					  <td class="text-left"><?php echo $entry_status; ?></td>
                      <td class="text-left"><span data-toggle="tooltip" title="<?php echo $help_partsCount; ?>"><?php echo $partsCount; ?></td>
					  <td class="text-left"><span data-toggle="tooltip" title="<?php echo $help_markup; ?>"><?php echo $markup; ?></td>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="text-left"><?php echo $credit_type_pp; ?></td>
					  <td>
						  <select name="product_pp" id="input-product_pp" class="form-control">
							<?php if ($product_pp) { ?>
								<option value="1" selected="selected"><?php echo $text_enabled; ?></option>
								<option value="0"><?php echo $text_disabled; ?></option>
							<?php } else { ?>
								<option value="1"><?php echo $text_enabled; ?></option>
								<option value="0" selected="selected"><?php echo $text_disabled; ?></option>
							<?php } ?>
						  </select>
					  </td>	
                      <td>
						  <select name="partscount_pp" id="input-partscount_pp" class="form-control">
						  <option value=""><?php echo $text_select; ?></option>
							<?php foreach ($partscounts as $partscount) { ?>
							<?php if ($partscount_pp == $partscount) { ?>
							<option value="<?php echo $partscount; ?>" selected="selected"><?php echo $partscount; ?></option>
							<?php } else { ?>
							<option value="<?php echo $partscount; ?>"><?php echo $partscount; ?></option>
							<?php } ?>
							<?php } ?>
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_pp" value="<?php echo $markup_pp; ?>" placeholder="1.0000" id="input-markup_pp" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left"><?php echo $credit_type_ii; ?></td>
					  <td>
						  <select name="product_ii" id="input-product_ii" class="form-control">
							<?php if ($product_ii) { ?>
								<option value="1" selected="selected"><?php echo $text_enabled; ?></option>
								<option value="0"><?php echo $text_disabled; ?></option>
							<?php } else { ?>
								<option value="1"><?php echo $text_enabled; ?></option>
								<option value="0" selected="selected"><?php echo $text_disabled; ?></option>
							<?php } ?>
						  </select>
					  </td>	
                      <td>
						  <select name="partscount_ii" id="input-partscount_ii" class="form-control">
						  <option value=""><?php echo $text_select; ?></option>
							<?php foreach ($partscounts as $partscount) { ?>
							<?php if ($partscount_ii == $partscount) { ?>
							<option value="<?php echo $partscount; ?>" selected="selected"><?php echo $partscount; ?></option>
							<?php } else { ?>
							<option value="<?php echo $partscount; ?>"><?php echo $partscount; ?></option>
							<?php } ?>
							<?php } ?>
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_ii" value="<?php echo $markup_ii; ?>" placeholder="1.0000" id="input-markup_ii" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left"><?php echo $credit_type_mb; ?></td>
					  <td>
						  <select name="product_mb" id="input-product_mb" class="form-control">
							<?php if ($product_mb) { ?>
								<option value="1" selected="selected"><?php echo $text_enabled; ?></option>
								<option value="0"><?php echo $text_disabled; ?></option>
							<?php } else { ?>
								<option value="1"><?php echo $text_enabled; ?></option>
								<option value="0" selected="selected"><?php echo $text_disabled; ?></option>
							<?php } ?>
						  </select>
					  </td>	
                      <td>
						  <select name="partscount_mb" id="input-partscount_mb" class="form-control">
						  <option value=""><?php echo $text_select; ?></option>
							<?php foreach ($partscounts as $partscount) { ?>
							<?php if ($partscount_mb == $partscount) { ?>
							<option value="<?php echo $partscount; ?>" selected="selected"><?php echo $partscount; ?></option>
							<?php } else { ?>
							<option value="<?php echo $partscount; ?>"><?php echo $partscount; ?></option>
							<?php } ?>
							<?php } ?>
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_mb" value="<?php echo $markup_mb; ?>" placeholder="1.0000" id="input-markup_mb" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left"><?php echo $credit_type_ab; ?></td>
					  <td>
						  <select name="product_ab" id="input-product_ab" class="form-control">
							<?php if ($product_ab) { ?>
								<option value="1" selected="selected"><?php echo $text_enabled; ?></option>
								<option value="0"><?php echo $text_disabled; ?></option>
							<?php } else { ?>
								<option value="1"><?php echo $text_enabled; ?></option>
								<option value="0" selected="selected"><?php echo $text_disabled; ?></option>
							<?php } ?>
						  </select>
					  </td>	
                      <td>
						  <select name="partscount_ab" id="input-partscount_ab" class="form-control">
						  <option value=""><?php echo $text_select; ?></option>
							<?php foreach ($partscounts as $partscount) { ?>
							<?php if ($partscount_ab == $partscount) { ?>
							<option value="<?php echo $partscount; ?>" selected="selected"><?php echo $partscount; ?></option>
							<?php } else { ?>
							<option value="<?php echo $partscount; ?>"><?php echo $partscount; ?></option>
							<?php } ?>
							<?php } ?>
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_ab" value="<?php echo $markup_ab; ?>" placeholder="1.0000" id="input-markup_ab" class="form-control" /></td>
                    </tr>
                  </tbody>
                </table>
              </div>			
			</div>
			<?php } ?>
			]]></add>
		</operation>
	</file>	
	<file path="admin/view/template/catalog/product_form.twig" error="skip">
		<operation error="skip">
			<search ><![CDATA[<li><a href="#tab-attribute" data-toggle="tab">{{ tab_attribute }}</a>]]></search>
			<add position="before"><![CDATA[
			{% if ukrcredits_status %}
			<li><a href="#tab-ukrcredits" data-toggle="tab">{{ tab_ukrcredits }}</a></li>
			{% endif %}
			]]></add>
		</operation>
		<operation error="skip">
			<search ><![CDATA[<div class="tab-pane" id="tab-attribute">]]></search>
			<add position="before"><![CDATA[
			{% if ukrcredits_status %}
			<div class="tab-pane" id="tab-ukrcredits">
              <div class="table-responsive">
                <table id="ukrcredits" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <td class="text-left">{{ credit_type }}</td>
					  <td class="text-left">{{ entry_status }}</td> 
                      <td class="text-left"><span data-toggle="tooltip" title="{{ help_partsCount }}">{{ partsCount }}</td>
					  <td class="text-left"><span data-toggle="tooltip" title="{{ help_markup }}">{{ markup }}</td>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="text-left">{{ credit_type_pp }}</td>
					  <td>
						  <select name="product_pp" id="input-product_pp" class="form-control">
							{% if product_pp %}
								<option value="1" selected="selected">{{ text_enabled }}</option>
								<option value="0">{{ text_disabled }}</option>
							{% else %}
								<option value="1">{{ text_enabled }}</option>
								<option value="0" selected="selected">{{ text_disabled }}</option>
							{% endif %}
						  </select>
					  </td>
                      <td>
						  <select name="partscount_pp" id="input-partscount_pp" class="form-control">
							<option value="">{{ text_select }}</option>
							{% for partscount in partscounts %}
							{% if partscount_pp == partscount %}
							<option value="{{ partscount }}" selected="selected">{{ partscount }}</option>
							{% else %}
							<option value="{{ partscount }}">{{ partscount }}</option>
							{% endif %}
							{% endfor %}
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_pp" value="{{ markup_pp }}" placeholder="1.0000" id="input-markup_pp" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left">{{ credit_type_ii }}</td>
					  <td>
						  <select name="product_ii" id="input-product_ii" class="form-control">
							{% if product_ii %}
								<option value="1" selected="selected">{{ text_enabled }}</option>
								<option value="0">{{ text_disabled }}</option>
							{% else %}
								<option value="1">{{ text_enabled }}</option>
								<option value="0" selected="selected">{{ text_disabled }}</option>
							{% endif %}
						  </select>
					  </td>
                      <td>
						  <select name="partscount_ii" id="input-partscount_ii" class="form-control">
							<option value="">{{ text_select }}</option>
							{% for partscount in partscounts %}
							{% if partscount_ii == partscount %}
							<option value="{{ partscount }}" selected="selected">{{ partscount }}</option>
							{% else %}
							<option value="{{ partscount }}">{{ partscount }}</option>
							{% endif %}
							{% endfor %}
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_ii" value="{{ markup_ii }}" placeholder="1.0000" id="input-markup_ii" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left">{{ credit_type_mb }}</td>
					  <td>
						  <select name="product_mb" id="input-product_mb" class="form-control">
							{% if product_mb %}
								<option value="1" selected="selected">{{ text_enabled }}</option>
								<option value="0">{{ text_disabled }}</option>
							{% else %}
								<option value="1">{{ text_enabled }}</option>
								<option value="0" selected="selected">{{ text_disabled }}</option>
							{% endif %}
						  </select>
					  </td>
                      <td>
						  <select name="partscount_mb" id="input-partscount_mb" class="form-control">
							<option value="">{{ text_select }}</option>
							{% for partscount in partscounts %}
							{% if partscount_mb == partscount %}
							<option value="{{ partscount }}" selected="selected">{{ partscount }}</option>
							{% else %}
							<option value="{{ partscount }}">{{ partscount }}</option>
							{% endif %}
							{% endfor %}
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_mb" value="{{ markup_mb }}" placeholder="1.0000" id="input-markup_mb" class="form-control" /></td>
                    </tr>
                    <tr>
                      <td class="text-left">{{ credit_type_ab }}</td>
					  <td>
						  <select name="product_ab" id="input-product_ab" class="form-control">
							{% if product_ab %}
								<option value="1" selected="selected">{{ text_enabled }}</option>
								<option value="0">{{ text_disabled }}</option>
							{% else %}
								<option value="1">{{ text_enabled }}</option>
								<option value="0" selected="selected">{{ text_disabled }}</option>
							{% endif %}
						  </select>
					  </td>
                      <td>
						  <select name="partscount_ab" id="input-partscount_ab" class="form-control">
							<option value="">{{ text_select }}</option>
							{% for partscount in partscounts %}
							{% if partscount_ab == partscount %}
							<option value="{{ partscount }}" selected="selected">{{ partscount }}</option>
							{% else %}
							<option value="{{ partscount }}">{{ partscount }}</option>
							{% endif %}
							{% endfor %}
						  </select>
					  </td>
					  <td class="text-left"><input type="text" name="markup_ab" value="{{ markup_ab }}" placeholder="1.0000" id="input-markup_ab" class="form-control" /></td>
                    </tr>
                  </tbody>
                </table>
              </div>			
			</div>
			{% endif %}
			]]></add>
		</operation>
	</file>	
	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[$data['header']]]></search>
			<add position="before"><![CDATA[
	if (version_compare(VERSION,'3.0','>=')) {
		if ($this->config->get('payment_ukrcredits_status')) {
			$data['ukrcredits_status'] = true;
			$data['ukrcredits'] = str_replace("\n", '', $this->load->controller('module/ukrcredits'));
			$data['ukrcredits_selector_button'] = strip_tags(html_entity_decode($this->config->get('payment_ukrcredits_settings')['selector_button'],ENT_QUOTES,'UTF-8'));
			$data['ukrcredits_selector_block'] = $this->config->get('payment_ukrcredits_settings')['selector_block'];
			$data['ukrcredits_css_custom'] = $this->config->get('payment_ukrcredits_settings')['css_custom'];
		} else {
			$data['ukrcredits_status'] = false;
		}
	} else {
		if ($this->config->get('ukrcredits_status')) {
			$data['ukrcredits_status'] = true;
			$data['ukrcredits'] = str_replace("\n", '', $this->load->controller('module/ukrcredits'));
			$data['ukrcredits_selector_button'] = strip_tags(html_entity_decode($this->config->get('ukrcredits_settings')['selector_button'],ENT_QUOTES,'UTF-8'));
			$data['ukrcredits_selector_block'] = $this->config->get('ukrcredits_settings')['selector_block'];
			$data['ukrcredits_css_custom'] = $this->config->get('ukrcredits_settings')['css_custom'];
		} else {
			$data['ukrcredits_status'] = false;
		}	
	}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[public function index()]]></search>
			<add position="after"><![CDATA[
			$this->document->addScript ('catalog/view/javascript/jquery/jquery-ui/jquery-ui.min.js');
			$this->document->addScript ('catalog/view/javascript/jquery/jquery-ui/jquery.ui.touch-punch.min.js');
			$this->document->addStyle ('catalog/view/javascript/jquery/magnific/magnific-popup.css');
			$this->document->addScript ('catalog/view/javascript/jquery/magnific/jquery.magnific-popup.min.js');
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/checkout.php">
		<operation>
			<search><![CDATA[$this->document->addStyle]]></search>
			<add position="before"><![CDATA[
			$this->document->addScript('catalog/view/javascript/jquery/jquery-ui/jquery-ui.min.js');
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/simplecheckout.php" error="skip">
		<operation>
			<search><![CDATA[$this->setOutputContent]]></search>
			<add position="before"><![CDATA[
			$this->document->addScript('catalog/view/javascript/jquery/jquery-ui/jquery-ui.min.js');
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/cart.php">
		<operation error="skip">
			<search><![CDATA[unset($this->session->data['payment_method']);]]></search>
			<add position="replace"><![CDATA[
			//unset($this->session->data['payment_method']);
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/cart.php">
		<operation error="skip">
			<search><![CDATA[unset($this->session->data['payment_methods']);]]></search>
			<add position="replace"><![CDATA[
			//unset($this->session->data['payment_methods']);
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/oct_fastorder.php" error="skip">
		<operation error="skip">
			<search><![CDATA[public function index() {]]></search>
			<add position="after"><![CDATA[
			$this->document->addScript('catalog/view/javascript/jquery/jquery-ui/jquery-ui.min.js');
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/extension/module/template_switcher.php">
		<operation error="skip">
			<search><![CDATA[if (!$this->config->get('module_template_switcher_status')) {]]></search>
			<add position="replace"><![CDATA[
			if (!$this->config->get('module_template_switcher_status') || strpos($route, 'ukrcredits')) {
			]]></add>
		</operation>
	</file>
	<file path="system/library/seopro.php">
		<operation error="skip">
			<search><![CDATA['error/not_found',]]></search>
			<add position="after"><![CDATA[
			'module/ukrcredits/loadpopup',
			]]></add>
		</operation>
	</file>
	<file path="catalog/model/catalog/product.php">
		<operation>
			<search index="0"><![CDATA[public function getProduct($product_id)]]></search>
			<add position="before"><![CDATA[
	public function getProductUkrcredits($product_id) {
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_id . "'");

		return $query->row;
	}
			]]></add>
		</operation>
	</file>	
	<file path="catalog/view/theme/*/template/product/product.tpl">
		<operation error="skip">
			<search ><![CDATA[<?php echo $footer; ?>]]></search>
			<add position="before"><![CDATA[
<?php if ($ukrcredits_status) { ?>
<script type="text/javascript"><!--
$('<?php echo $ukrcredits_selector_button; ?>').after('<?php echo $ukrcredits; ?>');
$('body').on('click', '#button-ukrcredits', function(){
  $('[data-toggle="tooltip"]').tooltip('hide');
  $.ajax({
    url: 'index.php?route=module/ukrcredits/checkoptions',
    type: 'post',
    data: $('<?php echo $ukrcredits_selector_block; ?> input[type=\'text\'], <?php echo $ukrcredits_selector_block; ?> input[type=\'hidden\'], <?php echo $ukrcredits_selector_block; ?> input[type=\'radio\']:checked, <?php echo $ukrcredits_selector_block; ?> input[type=\'checkbox\']:checked, <?php echo $ukrcredits_selector_block; ?> select, <?php echo $ukrcredits_selector_block; ?> textarea'),
    dataType: 'json',
    beforeSend: function() {
      $('#button-ukrcredits').button('loading');
    },
    complete: function() {
      $('#button-ukrcredits').button('reset');
    },
    success: function(json) {
      $('.alert, .text-danger').remove();
      $('.form-group').removeClass('has-error');

      if (json['error']) {
        if (json['error']['option']) {
          for (i in json['error']['option']) {
            var element = $('#input-option' + i.replace('_', '-'));

            if (element.parent().hasClass('input-group')) {
              element.parent().after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
            } else {
              element.after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
            }
          }
        }

        if (json['error']['recurring']) {
          $('select[name=\'recurring_id\']').after('<div class="text-danger">' + json['error']['recurring'] + '</div>');
        }

        // Highlight any found errors
        $('.text-danger').parent().addClass('has-error');
      }

      if (json['success']) {
		$.magnificPopup.open({
		//	type:'ajax',
			tLoading: '',
			tLoading: '<img src="catalog/view/theme/default/image/ukrcredits/PP_logo.png" />',
			removalDelay: 300,
			callbacks: {
				beforeOpen: function() {
				   this.st.mainClass = 'mfp-zoom-in';
				}
			},
			items:{
				type:'ajax',
				src:'index.php?route=module/ukrcredits/loadpopup'
			},
			ajax: {
			  settings: {
				type: 'GET',
				data: $('<?php echo $ukrcredits_selector_block; ?> input[type=\'text\'], <?php echo $ukrcredits_selector_block; ?> input[type=\'hidden\'], <?php echo $ukrcredits_selector_block; ?> input[type=\'radio\']:checked, <?php echo $ukrcredits_selector_block; ?> input[type=\'checkbox\']:checked, <?php echo $ukrcredits_selector_block; ?> select, <?php echo $ukrcredits_selector_block; ?> textarea'),
			  }
			}
		});	
      }
    },
    error: function(xhr, ajaxOptions, thrownError) {
      alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
    }
  });
});
//--></script>
<style>
#ukrcredit-popup {
  position: relative;
  background: #FFF;
  padding: 20px;
  width: auto;
  max-width: 750px;
  margin: 20px auto;
}
.mfp-zoom-in .mfp-content > div {
  opacity: 0;
  transition: all 0.2s ease-in-out;
  transform: scale(0.7);
}
.mfp-zoom-in.mfp-ready .mfp-content > div {
  opacity: 1;
  transform: scale(1);
}
.mfp-zoom-in.mfp-removing .mfp-content > div {
  transform: scale(0.7);
  opacity: 0;
}
<?php echo $ukrcredits_css_custom; ?>
</style>
<?php } ?>
			]]></add>
		</operation>
	</file>
	<file path="catalog/view/theme/*/template/product/product.twig">
		<operation>
			<search ><![CDATA[{{ footer }}]]></search>
			<add position="before"><![CDATA[
{% if ukrcredits_status %}
<script type="text/javascript"><!--
$('{{ ukrcredits_selector_button }}').after('{{ ukrcredits }}');
$('body').on('click', '#button-ukrcredits', function(){
  $('[data-toggle="tooltip"]').tooltip('hide');
  $.ajax({
    url: 'index.php?route=module/ukrcredits/checkoptions',
    type: 'post',
    data: $('{{ ukrcredits_selector_block }} input[type=\'text\'], {{ ukrcredits_selector_block }} input[type=\'hidden\'], {{ ukrcredits_selector_block }} input[type=\'radio\']:checked, {{ ukrcredits_selector_block }} input[type=\'checkbox\']:checked, {{ ukrcredits_selector_block }} select, {{ ukrcredits_selector_block }} textarea'),
    dataType: 'json',
    beforeSend: function() {
      $('#button-ukrcredits').button('loading');
    },
    complete: function() {
      $('#button-ukrcredits').button('reset');
    },
    success: function(json) {
      $('.alert, .text-danger').remove();
      $('.form-group').removeClass('has-error');

      if (json['error']) {
        if (json['error']['option']) {
          for (i in json['error']['option']) {
            var element = $('#input-option' + i.replace('_', '-'));

            if (element.parent().hasClass('input-group')) {
              element.parent().after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
            } else {
              element.after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
            }
          }
        }

        if (json['error']['recurring']) {
          $('select[name=\'recurring_id\']').after('<div class="text-danger">' + json['error']['recurring'] + '</div>');
        }

        // Highlight any found errors
        $('.text-danger').parent().addClass('has-error');
      }

      if (json['success']) {
		$.magnificPopup.open({
		//	type:'ajax',
			tLoading: '',
			tLoading: '<img src="catalog/view/theme/default/image/ukrcredits/PP_logo.png" />',
			removalDelay: 300,
			callbacks: {
				beforeOpen: function() {
				   this.st.mainClass = 'mfp-zoom-in';
				}
			},
			items:{
				type:'ajax',
				src:'index.php?route=module/ukrcredits/loadpopup'
			},
			ajax: {
			  settings: {
				type: 'GET',
				data: $('{{ ukrcredits_selector_block }} input[type=\'text\'], {{ ukrcredits_selector_block }} input[type=\'hidden\'], {{ ukrcredits_selector_block }} input[type=\'radio\']:checked, {{ ukrcredits_selector_block }} input[type=\'checkbox\']:checked, {{ ukrcredits_selector_block }} select, {{ ukrcredits_selector_block }} textarea'),
			  }
			}
		});	
      }
    },
    error: function(xhr, ajaxOptions, thrownError) {
      alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
    }
  });
});
//--></script>
<style>
#ukrcredit-popup {
  position: relative;
  background: #FFF;
  padding: 20px;
  width: auto;
  max-width: 750px;
  margin: 20px auto;
}
.mfp-zoom-in .mfp-content > div {
  opacity: 0;
  transition: all 0.2s ease-in-out;
  transform: scale(0.7);
}
.mfp-zoom-in.mfp-ready .mfp-content > div {
  opacity: 1;
  transform: scale(1);
}
.mfp-zoom-in.mfp-removing .mfp-content > div {
  transform: scale(0.7);
  opacity: 0;
}
{{ ukrcredits_css_custom }}
</style>
{% endif %}
			]]></add>
		</operation>
	</file>	
	<file path="catalog/controller/checkout/guest.php">
		<operation>
			<search><![CDATA[unset($this->session->data['payment_method']);]]></search>
			<add position="replace"><![CDATA[
//unset($this->session->data['payment_method']);
			]]></add>
		</operation>
	</file>	

	<file path="catalog/view/theme/*/template/checkout/simplecheckout_payment.{tpl,twig}">
		<operation error="skip">
			<search><![CDATA[<input type="hidden" name="payment_method_current]]></search>
			<add position="before"><![CDATA[
<script type="text/javascript">
$('#ukrcredits_ii').parent().after('<div id="uc_ii" style=""></div>');
if ($("#ukrcredits_ii").prop("checked")) {
	$('#uc_ii').load('index.php?route=module/ukrcredits_simple&uctype=ii');
}
$('#ukrcredits_pp').parent().after('<div id="uc_pp" style=""></div>');
if ($("#ukrcredits_pp").prop("checked")) {
	$('#uc_pp').load('index.php?route=module/ukrcredits_simple&uctype=pp');
}
$('#ukrcredits_mb').parent().after('<div id="uc_mb" style=""></div>');
if ($("#ukrcredits_mb").prop("checked")) {
	$('#uc_mb').load('index.php?route=module/ukrcredits_simple&uctype=mb');
}
$('#ukrcredits_ab').parent().after('<div id="uc_ab" style=""></div>');
if ($("#ukrcredits_ab").prop("checked")) {
	$('#uc_ab').load('index.php?route=module/ukrcredits_simple&uctype=ab');
}
</script>
			]]></add>
		</operation>
	</file>	

	
	<file path="system/library/cart/cart.php">
		<operation error="log">
			<search><![CDATA[public function getProducts(]]></search>
			<add position="after"><![CDATA[
				$type = version_compare(VERSION,'3.0','>=') ? 'payment_' : '';
				$typetotal = version_compare(VERSION,'3.0','>=') ? 'total_' : '';
				$setting = $this->config->get($type.'ukrcredits_settings');
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$price = $product_discount_query->row['price'];]]></search>
			<add position="replace"><![CDATA[
					if	(
							(	
								isset($this->session->data['payment_method']['code']) && 
								(
								($this->session->data['payment_method']['code'] == 'ukrcredits_pp' && !$setting['pp_special'])
								|| 
								($this->session->data['payment_method']['code'] == 'ukrcredits_ii' && !$setting['ii_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_mb' && !$setting['mb_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_ab' && !$setting['ab_special'])
								)
							)
							||
							(
								isset($this->session->data['payment_method']['code']) 
								&& 
								$this->session->data['payment_method']['code'] != 'ukrcredits_pp'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ii'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_mb'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ab'
							)
							||
							!isset($this->session->data['payment_method']['code'])
						)
					{
						$price = $product_discount_query->row['price'];
					}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$price = $product_special_query->row['price'];]]></search>
			<add position="replace"><![CDATA[
					if	(
							(	
								isset($this->session->data['payment_method']['code']) && 
								(
								($this->session->data['payment_method']['code'] == 'ukrcredits_pp' && !$setting['pp_special'])
								|| 
								($this->session->data['payment_method']['code'] == 'ukrcredits_ii' && !$setting['ii_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_mb' && !$setting['mb_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_ab' && !$setting['ab_special'])
								)
							)
							||
							(
								isset($this->session->data['payment_method']['code']) 
								&& 
								$this->session->data['payment_method']['code'] != 'ukrcredits_pp'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ii'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_mb'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ab'
							)
							||
							!isset($this->session->data['payment_method']['code'])
						)
					{
						$price = $product_special_query->row['price'];
					}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$product_data[] = array(]]></search>
			<add position="before"><![CDATA[
				$ucmarkup = 1;	
				if (!$this->config->get($typetotal.'totalukrcredits_status')) {
					if (isset($this->session->data['payment_method']['code'])) {
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_pp') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_pp']) && $ukrcredits_query->row['markup_pp'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_pp'];
								} else {
									$ucmarkup = $setting['pp_markup'];
								}
							}
							if ($setting['pp_markup_type'] == 'custom') {
								$ukrcredits_pp_sel = isset($this->session->data['ukrcredits_pp_sel'])?$this->session->data['ukrcredits_pp_sel']:1;
								$ucmarkup = ($setting['pp_markup_custom_PP'][$ukrcredits_pp_sel] + $setting['pp_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ii') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ii']) && $ukrcredits_query->row['markup_ii'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ii'];
								} else {
									$ucmarkup = $setting['ii_markup'];
								}
							}
							if ($setting['ii_markup_type'] == 'custom') {
								$ukrcredits_ii_sel = isset($this->session->data['ukrcredits_ii_sel'])?$this->session->data['ukrcredits_ii_sel']:1;
								$ucmarkup = ($setting['ii_markup_custom_II'][$ukrcredits_ii_sel] + $setting['ii_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_mb') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_mb']) && $ukrcredits_query->row['markup_mb'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_mb'];
								} else {
									$ucmarkup = $setting['mb_markup'];
								}
							}
							if ($setting['mb_markup_type'] == 'custom') {
								$ukrcredits_mb_sel = isset($this->session->data['ukrcredits_mb_sel'])?$this->session->data['ukrcredits_mb_sel']:2;
								$ucmarkup = ($setting['mb_markup_custom_MB'][$ukrcredits_mb_sel] + $setting['mb_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ab') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ab']) && $ukrcredits_query->row['markup_ab'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ab'];
								} else {
									$ucmarkup = $setting['ab_markup'];
								}
							}
							if ($setting['ab_markup_type'] == 'custom') {
								$ukrcredits_ab_sel = isset($this->session->data['ukrcredits_ab_sel'])?$this->session->data['ukrcredits_ab_sel']:3;
								$ucmarkup = ($setting['ab_markup_custom_AB'][$ukrcredits_ab_sel] + $setting['ab_markup_acquiring']) / 100 + 1;
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[($price + $option_price)]]></search>
			<add position="replace"><![CDATA[($price + $option_price) * $ucmarkup]]></add>
		</operation>
	</file>	
	
	<file path="system/library/cart.php">
		<operation error="log">
			<search><![CDATA[public function getProducts(]]></search>
			<add position="after"><![CDATA[
				$type = version_compare(VERSION,'3.0','>=') ? 'payment_' : '';
				$typetotal = version_compare(VERSION,'3.0','>=') ? 'total_' : '';
				$setting = $this->config->get($type.'ukrcredits_settings');
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$price = $product_discount_query->row['price'];]]></search>
			<add position="replace"><![CDATA[
					if	(
							(	
								isset($this->session->data['payment_method']['code']) && 
								(
								($this->session->data['payment_method']['code'] == 'ukrcredits_pp' && !$setting['pp_special'])
								|| 
								($this->session->data['payment_method']['code'] == 'ukrcredits_ii' && !$setting['ii_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_mb' && !$setting['mb_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_ab' && !$setting['ab_special'])
								)
							)
							||
							(
								isset($this->session->data['payment_method']['code']) 
								&& 
								$this->session->data['payment_method']['code'] != 'ukrcredits_pp'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ii'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_mb'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ab'
							)
							||
							!isset($this->session->data['payment_method']['code'])
						)
					{
						$price = $product_discount_query->row['price'];
					}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$price = $product_special_query->row['price'];]]></search>
			<add position="replace"><![CDATA[
					if	(
							(	
								isset($this->session->data['payment_method']['code']) && 
								(
								($this->session->data['payment_method']['code'] == 'ukrcredits_pp' && !$setting['pp_special'])
								|| 
								($this->session->data['payment_method']['code'] == 'ukrcredits_ii' && !$setting['ii_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_mb' && !$setting['mb_special'])
								||
								($this->session->data['payment_method']['code'] == 'ukrcredits_ab' && !$setting['ab_special'])
								)
							)
							||
							(
								isset($this->session->data['payment_method']['code']) 
								&& 
								$this->session->data['payment_method']['code'] != 'ukrcredits_pp'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ii'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_mb'
								&&
								$this->session->data['payment_method']['code'] != 'ukrcredits_ab'
							)
							||
							!isset($this->session->data['payment_method']['code'])
						)
					{
						$price = $product_special_query->row['price'];
					}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$this->data[$key] = array(]]></search>
			<add position="before"><![CDATA[
				$ucmarkup = 1;	
				if (!$this->config->get($typetotal.'totalukrcredits_status')) {
					if (isset($this->session->data['payment_method']['code'])) {
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_pp') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_pp']) && $ukrcredits_query->row['markup_pp'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_pp'];
								} else {
									$ucmarkup = $setting['pp_markup'];
								}
							}
							if ($setting['pp_markup_type'] == 'custom') {
								$ukrcredits_pp_sel = isset($this->session->data['ukrcredits_pp_sel'])?$this->session->data['ukrcredits_pp_sel']:1;
								$ucmarkup = ($setting['pp_markup_custom_PP'][$ukrcredits_pp_sel] + $setting['pp_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ii') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ii']) && $ukrcredits_query->row['markup_ii'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ii'];
								} else {
									$ucmarkup = $setting['ii_markup'];
								}
							}
							if ($setting['ii_markup_type'] == 'custom') {
								$ukrcredits_ii_sel = isset($this->session->data['ukrcredits_ii_sel'])?$this->session->data['ukrcredits_ii_sel']:1;
								$ucmarkup = ($setting['ii_markup_custom_II'][$ukrcredits_ii_sel] + $setting['ii_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_mb') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_mb']) && $ukrcredits_query->row['markup_mb'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_mb'];
								} else {
									$ucmarkup = $setting['mb_markup'];
								}
							}
							if ($setting['mb_markup_type'] == 'custom') {
								$ukrcredits_mb_sel = isset($this->session->data['ukrcredits_mb_sel'])?$this->session->data['ukrcredits_mb_sel']:2;
								$ucmarkup = ($setting['mb_markup_custom_MB'][$ukrcredits_mb_sel] + $setting['mb_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ab') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ab']) && $ukrcredits_query->row['markup_ab'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ab'];
								} else {
									$ucmarkup = $setting['ab_markup'];
								}
							}
							if ($setting['ab_markup_type'] == 'custom') {
								$ukrcredits_ab_sel = isset($this->session->data['ukrcredits_ab_sel'])?$this->session->data['ukrcredits_ab_sel']:3;
								$ucmarkup = ($setting['ab_markup_custom_AB'][$ukrcredits_ab_sel] + $setting['ab_markup_acquiring']) / 100 + 1;
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[$product_data[] = array(]]></search>
			<add position="before"><![CDATA[
				$ucmarkup = 1;	
				if (!$this->config->get($typetotal.'totalukrcredits_status')) {
					if (isset($this->session->data['payment_method']['code'])) {
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_pp') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_pp']) && $ukrcredits_query->row['markup_pp'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_pp'];
								} else {
									$ucmarkup = $setting['pp_markup'];
								}
							}
							if ($setting['pp_markup_type'] == 'custom') {
								$ukrcredits_pp_sel = isset($this->session->data['ukrcredits_pp_sel'])?$this->session->data['ukrcredits_pp_sel']:1;
								$ucmarkup = ($setting['pp_markup_custom_PP'][$ukrcredits_pp_sel] + $setting['pp_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ii') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ii']) && $ukrcredits_query->row['markup_ii'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ii'];
								} else {
									$ucmarkup = $setting['ii_markup'];
								}
							}
							if ($setting['ii_markup_type'] == 'custom') {
								$ukrcredits_ii_sel = isset($this->session->data['ukrcredits_ii_sel'])?$this->session->data['ukrcredits_ii_sel']:1;
								$ucmarkup = ($setting['ii_markup_custom_II'][$ukrcredits_ii_sel] + $setting['ii_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_mb') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_mb']) && $ukrcredits_query->row['markup_mb'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_mb'];
								} else {
									$ucmarkup = $setting['mb_markup'];
								}
							}
							if ($setting['mb_markup_type'] == 'custom') {
								$ukrcredits_mb_sel = isset($this->session->data['ukrcredits_mb_sel'])?$this->session->data['ukrcredits_mb_sel']:2;
								$ucmarkup = ($setting['mb_markup_custom_MB'][$ukrcredits_mb_sel] + $setting['mb_markup_acquiring']) / 100 + 1;
							}
						}
						if ($this->session->data['payment_method']['code'] == 'ukrcredits_ab') {
							$ukrcredits_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_ukrcredits WHERE product_id = '" . (int)$product_query->row['product_id'] . "'");
							if (isset($ukrcredits_query->row)) {
								if (isset($ukrcredits_query->row['markup_ab']) && $ukrcredits_query->row['markup_ab'] != 0) {
									$ucmarkup = $ukrcredits_query->row['markup_ab'];
								} else {
									$ucmarkup = $setting['ab_markup'];
								}
							}
							if ($setting['ab_markup_type'] == 'custom') {
								$ukrcredits_ab_sel = isset($this->session->data['ukrcredits_ab_sel'])?$this->session->data['ukrcredits_ab_sel']:2;
								$ucmarkup = ($setting['ab_markup_custom_AB'][$ukrcredits_ab_sel] + $setting['ab_markup_acquiring']) / 100 + 1;
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation error="log">
			<search><![CDATA[($price + $option_price)]]></search>
			<add position="replace"><![CDATA[($price + $option_price) * $ucmarkup]]></add>
		</operation>
	</file>	
	<file path="catalog/model/checkout/order.php">
		<operation>
			<search index="0"><![CDATA[public function addOrderHistory]]></search>
			<add position="before"><![CDATA[
	public function setUkrcreditsOrderId($order_id, $paymenttype, $mono_order_id, $mono_order_status, $mono_order_substatus = false) {
		$order_info=$this->getOrder($order_id);

		if ( $order_info && !$order_info['order_status_id'] ) {
			$this->db->query("INSERT INTO " . DB_PREFIX . "order_ukrcredits SET order_id = '" . (int)$order_id . "', ukrcredits_payment_type = '" . $this->db->escape($paymenttype) . "', ukrcredits_order_id = '" . $this->db->escape($mono_order_id) . "', ukrcredits_order_status = '" . $this->db->escape($mono_order_status) . "', ukrcredits_order_substatus = '" . $this->db->escape($mono_order_substatus) . "'");
	 	}		
	}			
	public function getOrderMb($mono_order_id) {
		$ordermb_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order_ukrcredits` WHERE ukrcredits_order_id = '" . $this->db->escape($mono_order_id) . "'");
		if ($ordermb_query->num_rows) {
			return $ordermb_query->row;			
		} else {
			return false;
		}
	}
	public function updateUkrcreditsOrderMono($order_id, $state, $substate) {
		$this->db->query("UPDATE " . DB_PREFIX . "order_ukrcredits SET ukrcredits_order_status = '" . $this->db->escape($state) . "', ukrcredits_order_substatus = '" . $this->db->escape($substate) . "' WHERE order_id = '" . (int)$order_id . "'");
	}
	public function updateUkrcreditsOrderPrivat($order_id, $privat_order_status) {
		$this->db->query("UPDATE " . DB_PREFIX . "order_ukrcredits SET ukrcredits_order_status = '" . $this->db->escape($privat_order_status) . "' WHERE order_id = '" . (int)$order_id . "'");
	}
			]]></add>
		</operation>
	</file>
</modification>